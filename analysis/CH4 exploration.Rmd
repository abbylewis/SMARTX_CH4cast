---
title: "Initial data exploration"
author: "Abby Lewis"
date: "2024-08-21"
output: html_document
---

## Load data and packages

QAQC

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)

ch4 <- read_csv("../Raw_data/GENX_Flux_SD_Loggernet_2021-05-05_to_2022-12-31_derived.csv", show_col_types = FALSE) %>%
  mutate(Temp = sub("e", "", zone_treatment),
         Temp = ifelse(Temp == "amb", 0, Temp),
         Temp = as.numeric(Temp),
         time2 = with_tz(time2, tzone = "America/New_York"))

ch4 <- read_csv("../L1_target.csv", show_col_types = FALSE) %>%
  mutate(date = as.Date(datetime),
         plot_id = site_id,
         chamber = site_id,
         CH4_rsquared = 1) %>%
  pivot_wider(names_from = variable,
              values_from = observation) %>%
  rename(CH4_slope_ppm_per_day = CH4_slope_umol_per_day) 
```

## Initial plots

Note that temperature treatments start the second year

```{r}
ch4 %>%
  filter(CH4_rsquared > 0.75) %>%
  ggplot(aes(x = date, y = CH4_slope_ppm_per_day)) +
  geom_line(aes(group = plot_id))+
  facet_wrap(~chamber)

ch4 %>%
  filter(CH4_rsquared > 0.75) %>%
  ggplot(aes(x = date, y = CH4_slope_umol_per_day)) +
  geom_line(aes(group = plot_id))+
  facet_wrap(~chamber)

ch4 %>%
  filter(CH4_rsquared > 0.75) %>%
  ggplot(aes(x = date, y = CH4_slope_ppm_per_day, color = zone_treatment)) +
  geom_smooth(se = F) +
  scale_color_viridis_d()

ch4 %>%
  filter(CH4_rsquared > 0.75) %>%
  ggplot(aes(x = date, y = CH4_slope_umol_per_day, color = zone_treatment)) +
  geom_smooth(se = F) +
  scale_color_viridis_d()

ch4 %>%
  filter(CH4_rsquared > 0.75) %>%
  select(CH4_slope_ppm_per_day, therm10c, time2, Temp) %>%
  pivot_longer(cols = c(CH4_slope_ppm_per_day, therm10c), names_to = "var", values_to = "value") %>%
  ggplot(aes(x = time2, y = value, color = as.factor(Temp))) +
  geom_line()+
  facet_wrap(~var, scales = "free")
```

Something is interesting about how temperature treatments affect variability of methane fluxes. There is greater day-to-day variability in the ambient treatment compared to the warmed treatment, particularly when CH4 fluxes are high.

UPDATE: this is a bit questionable because the temperature treatment didn't start until the second year

```{r}
all_dates <- ch4 %>%
  mutate(date_num = as.numeric(as.Date(time2)),
         year = year(time2)) %>%
  group_by(plot_id, chamber_treatment, zone_treatment, year) %>%
  expand(date_num = seq(min(date_num), max(date_num))) %>%
  mutate(Temp = sub("e", "", zone_treatment),
         Temp = ifelse(Temp == "amb", "0", Temp),
         Temp = as.numeric(Temp),
         year = year(as.Date(date_num)))

rolling <- ch4 %>% 
  filter(CH4_rsquared > 0.9) %>%
  mutate(date_num = as.numeric(as.Date(time2)),
         year = year(as.Date(date_num))) %>%
  group_by(plot_id, chamber_treatment, zone_treatment, year) %>% #, date_num) %>%
  #summarize(CH4_slope_ppm_per_day = mean(CH4_slope_ppm_per_day, na.rm = T)) %>%
  full_join(all_dates) %>%
  arrange(date_num) %>%
  mutate(Rolling_sd = slider::slide_index_dbl(.x = CH4_slope_ppm_per_day, 
                                                  .i = date_num, 
                                                  .f = sd, 
                                                  na.rm = T,
                                                  .before = 30),
         Rolling_mean = slider::slide_index_dbl(.x = CH4_slope_ppm_per_day, 
                                                  .i = date_num, 
                                                  .f = mean, 
                                                  na.rm = T,
                                                  .before = 30),
         Temp_group = ifelse(Temp >= 3, "High", "Low")) 

rolling %>%
  pivot_longer(cols = c("Rolling_sd", "Rolling_mean"), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = as.Date(date_num), y = Value, color = zone_treatment, group = chamber_treatment)) +
  geom_line()+
  facet_grid(rows = vars(Temp_group), cols = vars(Variable)) +
  scale_color_viridis_d()

rolling %>%
  ggplot(aes(x = Rolling_mean, y = Rolling_sd, color = zone_treatment)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm") +
  scale_color_viridis_d() +
  facet_wrap(~year)
```

[note: also tried median/IQR with same general result]

Is variability within a day also lower in high-temperature treatments? No- the main difference is between years rather than between treatments

```{r}
daily <- ch4 %>% 
  filter(CH4_rsquared > 0.9) %>%
  mutate(date_num = as.numeric(as.Date(time2)),
         year = year(as.Date(date_num))) %>%
  group_by(plot_id, chamber_treatment, zone_treatment, date_num, year) %>%
  mutate(Daily_sd = sd(CH4_slope_ppm_per_day, na.rm = T),
         Daily_mean = mean(CH4_slope_ppm_per_day, na.rm = T),
         Temp_group = ifelse(Temp >= 3, "High", "Low"),
         n = sum(!is.na(CH4_slope_ppm_per_day))) %>%
  filter(n > 5)

#Mean
daily %>%
  ggplot(aes(x = Daily_mean, y = Daily_sd, color = zone_treatment)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm") +
  scale_color_viridis_d() +
  facet_wrap(~year)

daily <- ch4 %>% 
  filter(CH4_rsquared > 0.9) %>%
  mutate(date_num = as.numeric(as.Date(time2))) %>%
  group_by(plot_id, chamber_treatment, zone_treatment, date_num) %>%
  mutate(Daily_iqr = IQR(CH4_slope_ppm_per_day, na.rm = T),
         Daily_median = median(CH4_slope_ppm_per_day, na.rm = T),
         Temp_group = ifelse(Temp >= 3, "High", "Low"),
         n = sum(!is.na(CH4_slope_ppm_per_day)),
         year = year(as.Date(date_num))) %>%
  filter(n > 5)

#Median
daily %>%
  ggplot(aes(x = Daily_median, y = Daily_iqr, color = zone_treatment)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm") +
  scale_color_viridis_d() +
  facet_wrap(~year)
```

A few more plots reinforcing that the main difference is between years rather than between treatments

```{r}
for_plot <- ch4 %>% 
  filter(CH4_rsquared > 0.9) %>%
  mutate(date_num = as.numeric(as.Date(time2)),
         hour = hour(time2),
         year = year(time2),
         time = ifelse(hour < 17 & hour > 9, "day",
                       ifelse(hour > 20 | hour < 4, "night", 
                              "other"))) %>%
  filter(!time == "other") %>%
  group_by(zone_treatment, year, time, date_num) %>%
  summarize(mean = mean(CH4_slope_umol_per_day, na.rm = T)) 

#In 2021, all treatments were higher at night. In 2022, these differences are gone. No clear indication that treatment influences the magnitude of variability within a day
for_plot %>%
  ggplot(aes(x = time, y = mean)) +
  geom_hline(yintercept = 0, color = "grey")+
  geom_boxplot(aes(color = zone_treatment))+
  facet_grid(cols = vars(zone_treatment), rows = vars(year), scales = "free") +
  scale_color_viridis_d()+
  theme_bw()+
  coord_cartesian(ylim = c(-50, 100))+
  theme(legend.position = "bottom")

for_plot %>%
  pivot_wider(names_from = time, values_from = mean) %>%
  filter(!is.na(day), !is.na(night)) %>%
  ggplot(aes(x = day, y = night)) +
  geom_abline(intercept = 0, slope = 1, color = "grey") +
  geom_smooth(aes(color = zone_treatment), method = "lm")+
  facet_wrap(~year)+
  scale_color_viridis_d()
```

## Tides

```{r}
library(VulnToolkit)
tides <- noaa(begindate = format(as.Date(min(ch4$time2)), "%Y%m%d"), 
                  enddate = format(as.Date(max(ch4$time2)), "%Y%m%d"), 
  station = "8461490", interval = "HL", 
  units = "meters", datum = "MHW", time = "GMT") %>%
  mutate(time_GMT = with_tz(time_GMT, tzone = "America/New_York"))

#Want to make a plot with hours since low tide on x axis and CH4 on y axis
ch4$recent_low <- NA
for(i in 1:nrow(ch4)){
  time <- ch4$time2[i]
  previous_lows <- tides$time_GMT[tides$time_GMT <= time & grepl("L", tides$tide)]
  recent_low = previous_lows[which.max(previous_lows)]
  ch4$recent_low[i] <- recent_low
}

ch4 %>%
  filter(CH4_rsquared > 0.9) %>%
  mutate(time_since_low = as.numeric(difftime(time2, recent_low, units = "hours")),
         year = year(time2)) %>%
  ggplot(aes(x = time_since_low, y = CH4_slope_umol_per_day, color = as.factor(year))) +
  geom_smooth() +
  facet_wrap(~Temp)

ch4 %>%
  filter(CH4_rsquared > 0.9) %>%
  mutate(time_since_low = as.numeric(difftime(time2, recent_low, units = "hours")),
         year = year(time2),
         hour = hour(time2),
         time = ifelse(hour < 17 & hour > 9, "day",
                       ifelse(hour > 20 | hour < 4, "night", 
                              "other"))) %>%
  filter(!time == "other",
         time_since_low <=12) %>%
  ggplot(aes(x = time_since_low, y = CH4_slope_umol_per_day, color = as.factor(zone_treatment), lty = time)) +
  geom_smooth() +
  #geom_point(alpha = 0.1) +
  facet_grid(cols = vars(time), rows = vars(year))+
  scale_color_viridis_d()

ch4 %>%
  filter(CH4_rsquared > 0.9) %>%
  mutate(time_since_low = as.numeric(difftime(time2, recent_low, units = "hours")),
         year = year(time2),
         hour = hour(time2),
         time = ifelse(hour < 17 & hour > 9, "day",
                       ifelse(hour > 20 | hour < 4, "night", 
                              "other"))) %>%
  filter(!time == "other",
         time_since_low <=12) %>%
  ggplot(aes(x = time_since_low)) +
  geom_histogram() +
  facet_wrap(~time)
```

```{r}
targets <- read_csv("../L1.csv")

jpeg("../figures/data.jpg", width = 8, height = 6, units = "in", res = 300)
targets %>%
  filter(datetime > "2022-12-01", datetime < "2023-01-31",
         !is.na(datetime)) %>%
  ggplot(aes(x = datetime, y = observation)) +
  geom_point() +
  facet_wrap(~site_id)
dev.off()

hist(ch4$corrected_depth)
```
